---
# add new variables
- type: replace
  path: /variables/-
  value:
    name: routing_api_ca
    type: certificate
    options:
      common_name: routing_api
      is_ca: true

- type: replace
  path: /variables/-
  value:
    name: routing_api_tls
    type: certificate
    options:
      ca: routing_api_ca
      common_name: routing-api.service.cf.internal
      extended_key_usage:
        - server_auth

- type: replace
  path: /variables/-
  value:
    name: routing_api_tls_client
    type: certificate
    options:
      ca: routing_api_ca
      common_name: routing-api-client
      extended_key_usage:
        - client_auth

# update Routing API properties
#   enabled_api_endpoints must be set to `both` to avoid downtime during the initial deploy.
#   this can be changed to `mtls` in later deploys.
- type: replace
  path: /instance_groups/name=api/jobs/name=routing-api/properties/routing_api/enabled_api_endpoints?
  value: "both"

- type: replace
  path: /instance_groups/name=api/jobs/name=routing-api/properties/routing_api/mtls_client_ca?
  value: "((routing_api_tls_client.ca))"

- type: replace
  path: /instance_groups/name=api/jobs/name=routing-api/properties/routing_api/mtls_server_cert?
  value: "((routing_api_tls.certificate))"

- type: replace
  path: /instance_groups/name=api/jobs/name=routing-api/properties/routing_api/mtls_server_key?
  value: "((routing_api_tls.private_key))"

# Update TCP Router
- type: replace
  path: /instance_groups/name=tcp-router/jobs/name=tcp_router/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=tcp-router/jobs/name=tcp_router/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=tcp-router/jobs/name=tcp_router/properties/routing_api?/ca_cert
  value: "((routing_api_ca.ca))"

# Update database route_registrar
- type: replace
  path: /instance_groups/name=database/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=database/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=database/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"

# Update uaa route_registrar
- type: replace
  path: /instance_groups/name=uaa/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=uaa/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=uaa/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"

# Update singleton-blobstore route_registrar
- type: replace
  path: /instance_groups/name=singleton-blobstore/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=singleton-blobstore/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=singleton-blobstore/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"

# Update api route_registrar
- type: replace
  path: /instance_groups/name=api/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=api/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=api/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"

# Update doppler route_registrar
- type: replace
  path: /instance_groups/name=doppler/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=doppler/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=doppler/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"

# Update log-api route_registrar
- type: replace
  path: /instance_groups/name=log-api/jobs/name=route_registrar/properties/routing_api?/client_cert
  value: "((routing_api_tls_client.certificate))"

- type: replace
  path: /instance_groups/name=log-api/jobs/name=route_registrar/properties/routing_api?/client_private_key
  value: "((routing_api_tls_client.private_key))"

- type: replace
  path: /instance_groups/name=log-api/jobs/name=route_registrar/properties/routing_api?/server_ca_cert
  value: "((routing_api_ca.ca))"
